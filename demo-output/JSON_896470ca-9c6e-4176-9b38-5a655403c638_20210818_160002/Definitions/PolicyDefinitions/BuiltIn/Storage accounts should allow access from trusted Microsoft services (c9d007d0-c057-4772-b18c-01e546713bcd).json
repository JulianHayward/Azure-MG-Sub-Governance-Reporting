{
  "displayName": "Storage accounts should allow access from trusted Microsoft services",
  "policyType": "BuiltIn",
  "mode": "Indexed",
  "description": "Some Microsoft services that interact with storage accounts operate from networks that can't be granted access through network rules. To help this type of service work as intended, allow the set of trusted Microsoft services to bypass the network rules. These services will then use strong authentication to access the storage account.",
  "metadata": {
    "version": "1.0.0",
    "category": "Storage"
  },
  "parameters": {
    "effect": {
      "type": "String",
      "metadata": {
        "displayName": "Effect",
        "description": "The effect determines what happens when the policy rule is evaluated to match"
      },
      "allowedValues": [
        "Audit",
        "Deny",
        "Disabled"
      ],
      "defaultValue": "Audit"
    }
  },
  "policyRule": {
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Storage/storageAccounts"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/networkAcls.bypass",
          "exists": "true"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/networkAcls.bypass",
          "notContains": "AzureServices"
        }
      ]
    },
    "then": {
      "effect": "[parameters('effect')]"
    }
  }
}

